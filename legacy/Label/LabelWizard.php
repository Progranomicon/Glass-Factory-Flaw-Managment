<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
	<link rel="stylesheet" type="text/css" href="css.css" >
	<script language="javascript" type="text/javascript" src="/../jquery.js" charset=utf-8></script>
</head>
<body>
<?php 
	if (isset($_GET['edit'])){
		include '/../conn.php';
		mysql_set_charset("utf8");
		echo '<script type="text/javascript">';
			echo ' var Production=[];
		'; 
        $RProduction = mysql_query("SELECT * FROM productionutf8 WHERE LabelHTML!='' AND id='".$_GET['edit']."'");
        while ($RetProd = mysql_fetch_assoc($RProduction)) {
			echo 'Production.push([' . $RetProd['id'] . ', "' . $RetProd['format_name'] . '", "'.$RetProd['units_number'].'", "'.$RetProd['LabelHTML'].'", "'.$RetProd['gost'].'"]); ';
			$testHTML=str_replace('&quot;', '"', $RetProd['LabelHTML']);
        }
		echo'</script>
		 ';
	}
?>
<?php 
	if (isset($_GET['edit']))
	echo $testHTML;
	else echo '<div id="LabelDiv"><div id="LabelDivImg" class="LabelDivImg"><img SRC="/Label/rszAndUmbr.png" style="padding-left:15px;padding-top:10px;"><img SRC="/../barcode.php?print=1&code=11111123334444&scale=2&mode=png&encoding=128&random=50027175" alt="Barcode-Result" style="-moz-transform : rotate(-90deg); margin-top:1.8cm; margin-left:-1.2cm;"/><img SRC="/Label/umbrAndRoof.png" style="padding-top:60px;padding-left:10px;"></div><div id="labelVarImg" class="labelVarImg" style="float:left;position:relative;width:0px;left:15.5cm;z-index:5;"></div><div id="LabelTextDiv"><hr id="curLine"></div></div>';
?>
	<div id="ToolsDiv">
	<div id="modeIndicator"></div>
		<input type="button" Value="↑ Курсор вверх" onclick="moveCurUp()"><br>
		<input type="button" Value="↓ Курсор вниз" onclick="moveCurDown()">
		<form name="form1">
			Добавить строку<br>
			<input type="hidden" id="editId" name="editId" Value="" >
			<a href="javascript:AddRow(0);">← Добавить Дату и номер паллета</a><br><br>
			<a href="javascript:AddRow(1);">← Добавить ЗАО "Рузаевский Стекольный Завод"</a><br><br>
			<a href="javascript:AddRow(2);">← Добавить ГОСТы и сертификаты</a><br><br>
			<a href="javascript:AddRow(3);">← Добавить адрес, телефон, E-mail</a><br><br>
			<a href="javascript:AddRow(12);">← Добавить тип продукции:</a><span id="spanType"> Бутылка стеклянная для пищевых жидкостей</span><br>
				<a style="margin-left:20px;" title="" href="javascript:function e(){document.getElementById('spanType').innerHTML=' Бутылка стеклянная для пищевых жидкостей'} e();"> Бутылка</a>
				<a title="" href="javascript:function e(){document.getElementById('spanType').innerHTML=' Банка стеклянная для пищевых продуктов'} e();">Банка</a>
				<a title="" href="javascript:function e(){document.getElementById('spanType').innerHTML=' Банка стеклянная для деского питания'} e();">Банка детская</a><br><br>
			<a href="javascript:AddRow(4);">← Добавить цвет стекла: </a><input Style="width:3cm;" type="text" name="colorText" Value="бесцветный" disabled><br>
				<a style="margin-left:20px; background-color:#fff;" title="бесцветный" href="javascript:function e(){document.getElementsByName('colorText')[0].value='бесцветный'} e();">бесцветный</a>
				<a style="background-color:#cfc;" title="зеленый" href="javascript:function e(){document.getElementsByName('colorText')[0].value='зеленый'} e();">зеленый</a>
				<a style="background-color:#c93;" title="коричневый" href="javascript:function e(){document.getElementsByName('colorText')[0].value='коричневый'} e();">коричневый</a><br><br>
			<a href="javascript:AddRow(5);">← Добавить название продукции: </a><input Style="width:7cm;" type="text" name="nameText" Value="" ><br> &nbsp &nbsp &nbsp &nbsp Размер шрифта названия:<input Style="width:1cm;" type="text" name="titleFontSize" Value="22" ><br><br>
			<a href="javascript:AddRow(10);">← Добавить СТО: </a><span id="spanSTO">СТО 99982965-001-2008</span> <input Style="margin-left:0.3cm;width:5cm;" type="text" name="STOText" Value="" ><br>
				<a style="margin-left:20px;" title="" href="javascript:function e(){document.getElementById('spanSTO').innerHTML='СТО 99982965-001-2008'} e();">СТО 99982965-001-2008</a>
				<a style="margin-left:10px;"title="" href="javascript:function e(){document.getElementById('spanSTO').innerHTML='СТО 99982968-002-2009'} e();">СТО 99982968-002-2009</a><br><br>
			<a href="javascript:AddRow(11);">← Добавить упаковку: </a><input Style="width:2cm;" type="text" name="boxingText" Value="ПКП" disabled><br>
				<a style="margin-left:20px;" title="Пластиковый короб + прокладка" href="javascript:function e(){document.getElementsByName('boxingText')[0].value='ПКП'} e();">ПКП</a>
				<a title="Пластоковая прокладка + гофрокороб" href="javascript:function e(){document.getElementsByName('boxingText')[0].value='ПП'} e();">ПП</a>
				<a title="Гофропрокладка" href="javascript:function e(){document.getElementsByName('boxingText')[0].value='ГП'} e();">ГП</a>
				<a title="Гофрокороб" href="javascript:function e(){document.getElementsByName('boxingText')[0].value='ГК'} e();">ГК</a><br><br>
			<a href="javascript:AddRow(8);">← Добавить срок годности</a><br><br>			
			<a href="javascript:AddRow(6);">← Добавить количество: </a><input Style="width:1.5cm;" type="text" name="countText" > шт.,  размеры <input Style="width:2cm;" type="text" name="sizeText" > м., номер линии.<br><br>
			<a href="javascript:AddRow(7);">← Добавить свой текст: </a><input Style="width:10cm;" type="text" name="rowText" Value="" ><br>&nbsp &nbsp &nbsp &nbsp Размер шрифта:<input Style="width:1cm;" type="text" name="fontSize" Value="12" >
			<input type="checkbox" name="b"> <b>жирный</b> <input type="checkbox" name="i"> <i>курсив</i> <input type="checkbox" name="u"> <u>подчеркнутый</u> <br><br>
			<a href="javascript:AddRow(9);">← Добавить номер партии</a><br>
			<br><hr><a href="javascript:ShowHelp();" style="color:green;">Показать справку</a><br><br>
			<input type="button" Value="Записать в базу" onclick="recLabel()"><br><br><span style="font-size:1.5em; color:green; padding-left:150px;"><a href="makeLabel2.php">←Назад к списку форматов</a></span>
		</form>
	</div>
	<div class="imagesToPaste" id="varImages">
		<h3>Добавьте картинки кликом:<h3>
		<img SRC="/Label/cir.png" class="imag" style="padding:5px;" onclick="imageClick(this)">
		<img SRC="/Label/tri.png" class="imag" style="padding:5px;" onclick="imageClick(this)">
		<img SRC="/Label/tri71.png" class="imag" style="padding:5px;" onclick="imageClick(this)">
		<img SRC="/Label/tri72.png" class="imag" style="padding:5px;" onclick="imageClick(this)">
		<img SRC="/Label/rst.png" class="imag" style="padding:5px;" onclick="imageClick(this)">
		<img SRC="/Label/EAC.png" class="imag" style="padding:5px;" onclick="imageClick(this)">
	</div>
	<div id="Help">
	<div style="float:right;"><a href="javascript:CloseHelp();">Закрыть</a></div>
		<h2>Справка</h2>
		<p>Чтобы добавлять нужные строки на формируемый ярлык шелкайте по соответствующим ссылкам в правой части экрана.
Новые строки будут добавляться в месте расположения курсора (синяя пунктирная линия) на ярлыке. Для добавления строк между уже добавленных
курсор нужно передвинуть щелкая на ссответствующие кнопки ("Курсор вверх", "Курсор вниз") справа.
 </p><p>Обязательными для заполнения являются поли названия и количества изделий. Если их не заполнить, ярлык не будет записан.</p>
 <p> 
 <b>Записывается то название и количество продукции, которые на момент нажатия кнопки "Записать в базу" находится в поле названия продукции.</b></p>
 <p> 
 Чтобы удалить строку с ярлыка наведите курсор мыши на удаляемую строку, ее фон должен стать розоватого оттенка. Щелкните левой кнопкой.
		</p>
		<p>Название необходимо добавлять только через специальное поле, предназначенное для названия (Никак не через поле "Свой текст").
		 </p>
		 <p>Для добавления пиктограмм просто щелкните на них левой кнопкой мыши. Удаляются они аналогично строкам.</p>
	</div>
	<script type="text/javascript">
		var node = document.getElementById("LabelTextDiv");
		var children = node.childNodes;
		var xmlHttpTOs = false;
		/*@cc_on @*/
		/*@if (@_jscript_version >= 5)
		try {
		  xmlHttpTOs = new ActiveXObject("Msxml2.XMLHTTP");
		} catch (e) {
		  try {
			xmlHttpTOs = new ActiveXObject("Microsoft.XMLHTTP");
		  } catch (e2) {
			xmlHttpTOs = false;
		  }
		}
		@end @*/
		if (!xmlHttpTOs && typeof XMLHttpRequest != 'undefined') {
		  xmlHttpTOs = new XMLHttpRequest();
		}
		function CloseHelp(){$("#Help").css('display','none');}
		function ShowHelp(){
			$("#Help").css('display','block');
			}
		
		function recLabel() 
		{
			var Label= document.getElementById('LabelDiv');
			var Format= document.getElementsByName('nameText')[0].value;
			var countPerPallet = document.getElementsByName('countText')[0].value;
			var editId = document.getElementsByName('editId')[0].value;
			var boxingText = document.getElementsByName('boxingText')[0].value;
			var colorText = document.getElementsByName('colorText')[0].value;
			var gostSap= document.getElementsByName('STOText')[0].value;
			removeNode(document.getElementById('curLine'));
			
			// Создать URL для подключения
			var url = "RecLabel.php?Label=" + encodeURIComponent(Label.outerHTML)+'&Format='+encodeURIComponent(Format)+'&CountPerPal='+countPerPallet+'&Edit='+editId+'&Boxing='+encodeURIComponent(boxingText)+'&Color='+encodeURIComponent(colorText)+'&Gost='+encodeURIComponent(gostSap);
			// Открыть соединение с сервером
			xmlHttpTOs.open("GET", url, true);
			// Установить функцию для сервера, которая выполнится после его ответа
			xmlHttpTOs.onreadystatechange = recResult;
			var curLineElem = document.createElement('HR');
			curLineElem.id ="curLine";
			node.insertBefore(curLineElem, node.childNodes[-1]);
			// SПередать запрос
			xmlHttpTOs.send(null);
		}
		function recResult()
		{
			if (xmlHttpTOs.readyState == 4) {
				var response = xmlHttpTOs.responseText;
				alert(response);
			}
		}
		
		function AddRow(v){
			var text='ERROR. v='+v;
			if (v === undefined) v=getRadioGroupValue(document.form1.rowSelect);
			if (v==null) alert("Выберите один из пунктов");
			if (v==0) text='<table align="center"><tr><th id=t><b><i>№ паллета:</i></b></th><th><b><i>Дата производства</i></b></th></tr><tr><td id=t><br><FONT size=7><b><span id="pallet_s">%N%</span></b></FONT></td><td><br><FONT size=5><b>%date%</b></FONT></td></tr></table>';
			if (v==1) text='ЗАО "Рузаевский Cтекольный Завод"';
			if (v==2) text='ГОСТ Р ИСО 9001-2008, ГОСТ Р ИСО 22000-2007, <br>ГОСТ Р ИСО 14001-2007<br> &nbsp &nbsp &nbsp &nbsp (Сертификат соотвествия №СДС.Э.СМК 000850-12 от 30.11.2012)"';
			if (v==3) text='Республика Мордовия, г. Рузаевка,ул. Станиславского, д. 22<br>Телефон: (83451)9-42-01, E-mail:info@ruzsteklo.ru';
			if (v==4) text='Цвет стекла: <i><b>'+document.getElementsByName('colorText')[0].value+'</b></i>';
			if (v==5) text='Условное обозначение продукции<br><span style="Font-size:'+document.getElementsByName('titleFontSize')[0].value+'px;"><u>'+document.getElementsByName('nameText')[0].value+'</u></span>';
			if (v==6) text='<div style="text-align:left;left:7cm;width:7cm;position:relative;">Количество изделий:<b>'+document.getElementsByName('countText')[0].value+'</b> шт.<br><br> Габаритные размеры: <b>'+document.getElementsByName('sizeText')[0].value+' </b>м.<br><br>Номер м/линии: <span style="Font-size:26px;">%l%</span></div>';
			if (v==7) { /* пустая строка или свой текст*/
				if (document.getElementsByName('rowText')[0].value=='') text='<span  style="Font-size:'+document.getElementsByName('fontSize')[0].value+'px;"><br></span>';
				else{ text='<span  style="Font-size:'+document.getElementsByName('fontSize')[0].value+'px;';
					if (document.getElementsByName('b')[0].checked) text+='font-weight:bold; ';
					if (document.getElementsByName('i')[0].checked) text+='font-style:italic; ';
					if (document.getElementsByName('u')[0].checked) text+='text-decoration:underline; ';
					text+='">'+document.getElementsByName('rowText')[0].value+'</span>';
				}
			}
			if (v==8) text='Срок годности - до %vd% г.';
			if (v==9) text='Номер производственной партии <b>%pn%</b>.';
			if (v==10){ 
				if(document.getElementsByName('STOText')[0].value=='') text='<span style="font-size:10px;">'+document.getElementById('spanSTO').innerHTML+'</span>';
				else text='<span style="font-size:10px;">'+document.getElementById('spanSTO').innerHTML+', '+document.getElementsByName('STOText')[0].value+'</span>';
			}
			if (v==11) text='('+document.getElementsByName('boxingText')[0].value+')';
			if (v==12) text='<b><i>'+document.getElementById('spanType').innerHTML+'</i></b>';
			var newRowElem = document.createElement('div');
			newRowElem.innerHTML=text;
			newRowElem.className ='rowDiv';
			if (v==5 || v==6) newRowElem.id="undel";
			newRowElem.onclick = function(){delReq(this);};
			curLine = document.getElementById('curLine');
			document.getElementById('LabelTextDiv').insertBefore(newRowElem, curLine);
		}
		function getRadioGroupValue(radioGroupObj){
			for (var i=0; i < radioGroupObj.length; i++)
				if (radioGroupObj[i].checked) return i;
			return null;
		}
		function removeNode(elem){
			elem.parentNode.removeChild(elem);
			return;
		}
		function moveCurUp(){
			pos = getHRPos();
			removeNode(document.getElementById('curLine'));
			var curLineElem = document.createElement('HR');
			curLineElem.id ="curLine";
			node.insertBefore(curLineElem, node.childNodes[pos-1]);
		}
		function moveCurDown(){
			pos = getHRPos();
			removeNode(document.getElementById('curLine'));
			var curLineElem = document.createElement('HR');
			curLineElem.id ="curLine";
			node.insertBefore(curLineElem, node.childNodes[pos+1]);
		}
		function getHRPos(){
			var node = document.getElementById('LabelTextDiv');
			var el=null;
			var children = node.childNodes
			for(var i=0;i<children.length; i++) {
				if (children[i].tagName=="HR")
					return i;
			}
		}
		function imageClick(obj){
			if (obj.className=='imag'){
				document.getElementById('labelVarImg').appendChild(obj);
				obj.className='imagAdded';
			}
			else{
				if (confirm('Удалить пиктограмму?')){
                      document.getElementById('varImages').appendChild(obj);
					obj.className='imag';
                 } 
                 else {
                      return false;
                 }
			}
			
		}
		function delReq(elem){
		if (elem.id=='undel' & document.getElementsByName('editId')[0].value!=""){
			alert('При редактировании \r\n нельзя удалять Название или Количество.');
			return false;
		}
		else if (confirm('Удалить строку?')){
				removeNode(elem);
			}
             else {
                 return false;
             } 
		}
		function checkMode(){
			var Format= document.getElementsByName('nameText')[0].value;
			var countPerPallet = document.getElementsByName('countText')[0].value;
			var MI=document.getElementById('modeIndicator');
			if (typeof Production=="undefined"){
				MI.innerHTML="Создание нового формата";
			}
			else{
				if (Format!=Production[0][1] || countPerPallet!=Production[0][2]){
					MI.innerHTML="Создание нового формата";
					document.getElementsByName('editId')[0].value="";
				}
				else{
					MI.innerHTML="Редактирование "+Production[0][1];
					document.getElementsByName('editId')[0].value=Production[0][0];
					document.getElementsByName('STOText')[0].value=Production[0][4];
					document.getElementsByName('nameText')[0].disabled=true;
					document.getElementsByName('countText')[0].disabled=true;
				}
			}
		}
		
<?php 
	if (isset($_GET['edit'])){
	echo 'var curLineElem = document.createElement("HR");
			curLineElem.id ="curLine";
			node.insertBefore(curLineElem, node.childNodes[-1]);';
	echo 'var node = document.getElementById("LabelTextDiv");
			var children = node.childNodes
			for(var i=0;i<children.length; i++) {
				if (children[i].tagName!="HR")
				children[i].onclick = function(){delReq(this);};
					;
			}';
	//echo 'document.getElementById("labelVarImg").innerHTML="";';
	echo 'document.getElementById("editId").value=Production[0][0];';
	echo 'document.getElementsByName("countText")[0].value=Production[0][2];';
	echo 'document.getElementsByName("nameText")[0].value=Production[0][1];';
	//echo "alert ('Обратите внимание, что пиктограммы в правой части сбросились. Расставьте их заново.');";
	}
	
?>
	checkMode();
	</script>
</body>
</html>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                